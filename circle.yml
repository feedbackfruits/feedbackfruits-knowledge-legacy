machine:
  node:
    version: 8
dependencies:
  cache_directories:
    - elasticsearch-5.1.1
    - cayley_v0.6.1_linux_386
  pre:
    - npm install -g npm
  post:
    # Elasticsearch
    - if [[ ! -e elasticsearch-5.1.1 ]]; then wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.1.tar.gz && tar -xvf elasticsearch-5.1.1.tar.gz; fi
    - elasticsearch-5.1.1/bin/elasticsearch: {background: true}
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/

    # Seed Elasticsearch
    - |
      curl --fail -H "Content-Type: application/x-ndjson" -XPOST --data-binary @seeds/elasticsearch.ndjson localhost:9200/_bulk

    # Cayley
    - if [[ ! -e cayley_v0.6.1_linux_386 ]]; then wget https://github.com/cayleygraph/cayley/releases/download/v0.6.1/cayley_v0.6.1_linux_386.tar.gz && tar -xvf cayley_v0.6.1_linux_386.tar.gz; fi
    - cd cayley_v0.6.1_linux_386 && ./cayley http --dbpath=../seeds/cayley.nq --host 0.0.0.0 --port 64210: {background: true}
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:64210/
test:
  post:
    - npm run coverage
    - cp -R coverage $CIRCLE_ARTIFACTS
deployment:
  production:
    tag: /v[0-9]+(\.[0-9]+)*/
    heroku:
      appname: feedbackfruits-knowledge
  staging:
    branch: master
    heroku:
      appname: staging-fbf-knowledge
